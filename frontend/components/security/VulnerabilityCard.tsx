'use client'

import React from 'react'
import {
    AlertTriangle, Shield, ShieldAlert, ShieldCheck, Info,
    ExternalLink, Copy, CheckCircle, XCircle, Clock, User,
    ChevronDown, ChevronUp, Code, FileText, Link as LinkIcon
} from 'lucide-react'
import { Button } from '@/components/ui/button'
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
import { Badge } from '@/components/ui/badge'
import {
    Collapsible,
    CollapsibleContent,
    CollapsibleTrigger
} from '@/components/ui/collapsible'

interface Vulnerability {
    id: string
    human_id: string
    title: string
    description: string
    category: string
    severity: string
    cvss_score: number | null
    cvss_vector: string | null
    affected_component: string | null
    affected_url: string | null
    affected_file: string | null
    affected_line: number | null
    evidence: string | null
    cve_id: string | null
    cwe_id: string | null
    package_name: string | null
    package_version: string | null
    fixed_version: string | null
    remediation: string | null
    ai_remediation: string | null
    is_false_positive: boolean
    is_verified: boolean
    is_resolved: boolean
    discovered_at: string
    references: string[]
}

interface VulnerabilityCardProps {
    vulnerability: Vulnerability
    onMarkResolved?: (id: string) => void
    onMarkFalsePositive?: (id: string) => void
    onGenerateAIRemediation?: (id: string) => void
    expanded?: boolean
}

const getSeverityConfig = (severity: string) => {
    switch (severity.toLowerCase()) {
        case 'critical':
            return {
                color: 'bg-red-500 text-white',
                borderColor: 'border-l-red-500',
                icon: <ShieldAlert className="w-5 h-5 text-red-500" />,
                bgLight: 'bg-red-50'
            }
        case 'high':
            return {
                color: 'bg-orange-500 text-white',
                borderColor: 'border-l-orange-500',
                icon: <AlertTriangle className="w-5 h-5 text-orange-500" />,
                bgLight: 'bg-orange-50'
            }
        case 'medium':
            return {
                color: 'bg-yellow-500 text-white',
                borderColor: 'border-l-yellow-500',
                icon: <Shield className="w-5 h-5 text-yellow-500" />,
                bgLight: 'bg-yellow-50'
            }
        case 'low':
            return {
                color: 'bg-blue-500 text-white',
                borderColor: 'border-l-blue-500',
                icon: <ShieldCheck className="w-5 h-5 text-blue-500" />,
                bgLight: 'bg-blue-50'
            }
        case 'info':
            return {
                color: 'bg-gray-400 text-white',
                borderColor: 'border-l-gray-400',
                icon: <Info className="w-5 h-5 text-gray-400" />,
                bgLight: 'bg-gray-50'
            }
        default:
            return {
                color: 'bg-gray-400 text-white',
                borderColor: 'border-l-gray-400',
                icon: <Shield className="w-5 h-5 text-gray-400" />,
                bgLight: 'bg-gray-50'
            }
    }
}

export function VulnerabilityCard({
    vulnerability,
    onMarkResolved,
    onMarkFalsePositive,
    onGenerateAIRemediation,
    expanded = false
}: VulnerabilityCardProps) {
    const [isOpen, setIsOpen] = React.useState(expanded)
    const severityConfig = getSeverityConfig(vulnerability.severity)

    const copyToClipboard = (text: string) => {
        navigator.clipboard.writeText(text)
    }

    return (
        <Card className={`border-l-4 ${severityConfig.borderColor}`}>
            <Collapsible open={isOpen} onOpenChange={setIsOpen}>
                <CollapsibleTrigger asChild>
                    <CardHeader className="cursor-pointer hover:bg-gray-50 transition-colors">
                        <div className="flex items-start justify-between">
                            <div className="flex items-start gap-3">
                                {severityConfig.icon}
                                <div className="space-y-1">
                                    <div className="flex items-center gap-2">
                                        <CardTitle className="text-base font-semibold text-gray-900">
                                            {vulnerability.title}
                                        </CardTitle>
                                        <Badge variant="outline" className="text-xs font-mono">
                                            {vulnerability.human_id}
                                        </Badge>
                                        {vulnerability.is_resolved && (
                                            <Badge className="bg-green-100 text-green-700">
                                                <CheckCircle className="w-3 h-3 mr-1" />
                                                Resolved
                                            </Badge>
                                        )}
                                        {vulnerability.is_false_positive && (
                                            <Badge className="bg-gray-100 text-gray-700">
                                                <XCircle className="w-3 h-3 mr-1" />
                                                False Positive
                                            </Badge>
                                        )}
                                    </div>
                                    <div className="flex items-center gap-2 text-sm text-gray-500">
                                        <Badge className={severityConfig.color}>
                                            {vulnerability.severity}
                                        </Badge>
                                        {vulnerability.cvss_score && (
                                            <span className="font-medium">
                                                CVSS: {vulnerability.cvss_score.toFixed(1)}
                                            </span>
                                        )}
                                        <span className="text-gray-300">|</span>
                                        <span>{vulnerability.category}</span>
                                        {vulnerability.cve_id && (
                                            <>
                                                <span className="text-gray-300">|</span>
                                                <Badge variant="outline" className="font-mono text-xs">
                                                    {vulnerability.cve_id}
                                                </Badge>
                                            </>
                                        )}
                                    </div>
                                </div>
                            </div>
                            <div className="flex items-center gap-2">
                                <span className="text-sm text-gray-400">
                                    {new Date(vulnerability.discovered_at).toLocaleDateString()}
                                </span>
                                {isOpen ? (
                                    <ChevronUp className="w-5 h-5 text-gray-400" />
                                ) : (
                                    <ChevronDown className="w-5 h-5 text-gray-400" />
                                )}
                            </div>
                        </div>
                    </CardHeader>
                </CollapsibleTrigger>

                <CollapsibleContent>
                    <CardContent className="pt-0 space-y-4">
                        {/* Description */}
                        <div>
                            <h4 className="text-sm font-medium text-gray-700 mb-1">Description</h4>
                            <p className="text-sm text-gray-600">{vulnerability.description}</p>
                        </div>

                        {/* Affected Location */}
                        {(vulnerability.affected_url || vulnerability.affected_file || vulnerability.affected_component) && (
                            <div className={`p-3 rounded-lg ${severityConfig.bgLight}`}>
                                <h4 className="text-sm font-medium text-gray-700 mb-2">Affected Location</h4>
                                <div className="space-y-1 text-sm">
                                    {vulnerability.affected_component && (
                                        <div className="flex items-center gap-2">
                                            <Code className="w-4 h-4 text-gray-400" />
                                            <span className="font-medium">Component:</span>
                                            <code className="bg-white px-2 py-0.5 rounded">{vulnerability.affected_component}</code>
                                        </div>
                                    )}
                                    {vulnerability.affected_url && (
                                        <div className="flex items-center gap-2">
                                            <LinkIcon className="w-4 h-4 text-gray-400" />
                                            <span className="font-medium">URL:</span>
                                            <code className="bg-white px-2 py-0.5 rounded text-teal-600 break-all">
                                                {vulnerability.affected_url}
                                            </code>
                                            <Button
                                                variant="ghost"
                                                size="sm"
                                                onClick={() => copyToClipboard(vulnerability.affected_url!)}
                                            >
                                                <Copy className="w-3 h-3" />
                                            </Button>
                                        </div>
                                    )}
                                    {vulnerability.affected_file && (
                                        <div className="flex items-center gap-2">
                                            <FileText className="w-4 h-4 text-gray-400" />
                                            <span className="font-medium">File:</span>
                                            <code className="bg-white px-2 py-0.5 rounded">
                                                {vulnerability.affected_file}
                                                {vulnerability.affected_line && `:${vulnerability.affected_line}`}
                                            </code>
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}

                        {/* Dependency Info */}
                        {vulnerability.package_name && (
                            <div className="p-3 rounded-lg bg-purple-50">
                                <h4 className="text-sm font-medium text-gray-700 mb-2">Affected Dependency</h4>
                                <div className="flex items-center gap-4 text-sm">
                                    <span>
                                        <span className="font-medium">{vulnerability.package_name}</span>
                                        <span className="text-gray-500">@{vulnerability.package_version}</span>
                                    </span>
                                    {vulnerability.fixed_version && (
                                        <Badge className="bg-green-100 text-green-700">
                                            Fix available: {vulnerability.fixed_version}
                                        </Badge>
                                    )}
                                </div>
                            </div>
                        )}

                        {/* Evidence */}
                        {vulnerability.evidence && (
                            <div>
                                <h4 className="text-sm font-medium text-gray-700 mb-1">Evidence</h4>
                                <pre className="text-xs bg-gray-900 text-green-400 p-3 rounded-lg overflow-x-auto">
                                    {vulnerability.evidence}
                                </pre>
                            </div>
                        )}

                        {/* Remediation */}
                        {(vulnerability.remediation || vulnerability.ai_remediation) && (
                            <div className="p-3 rounded-lg bg-green-50 border border-green-200">
                                <h4 className="text-sm font-medium text-green-700 mb-2">
                                    {vulnerability.ai_remediation ? 'ðŸ¤– AI-Suggested Remediation' : 'Remediation'}
                                </h4>
                                <p className="text-sm text-green-800 whitespace-pre-wrap">
                                    {vulnerability.ai_remediation || vulnerability.remediation}
                                </p>
                            </div>
                        )}

                        {/* References */}
                        {vulnerability.references && vulnerability.references.length > 0 && (
                            <div>
                                <h4 className="text-sm font-medium text-gray-700 mb-2">References</h4>
                                <ul className="space-y-1">
                                    {vulnerability.references.map((ref, idx) => (
                                        <li key={idx}>
                                            <a
                                                href={ref}
                                                target="_blank"
                                                rel="noopener noreferrer"
                                                className="text-sm text-teal-600 hover:underline flex items-center gap-1"
                                            >
                                                <ExternalLink className="w-3 h-3" />
                                                {ref}
                                            </a>
                                        </li>
                                    ))}
                                </ul>
                            </div>
                        )}

                        {/* Actions */}
                        <div className="flex items-center gap-2 pt-2 border-t">
                            {!vulnerability.is_resolved && onMarkResolved && (
                                <Button
                                    variant="outline"
                                    size="sm"
                                    onClick={() => onMarkResolved(vulnerability.id)}
                                >
                                    <CheckCircle className="w-4 h-4 mr-1" />
                                    Mark Resolved
                                </Button>
                            )}
                            {!vulnerability.is_false_positive && onMarkFalsePositive && (
                                <Button
                                    variant="outline"
                                    size="sm"
                                    onClick={() => onMarkFalsePositive(vulnerability.id)}
                                >
                                    <XCircle className="w-4 h-4 mr-1" />
                                    False Positive
                                </Button>
                            )}
                            {!vulnerability.ai_remediation && onGenerateAIRemediation && (
                                <Button
                                    variant="outline"
                                    size="sm"
                                    onClick={() => onGenerateAIRemediation(vulnerability.id)}
                                >
                                    ðŸ¤– Generate AI Remediation
                                </Button>
                            )}
                        </div>
                    </CardContent>
                </CollapsibleContent>
            </Collapsible>
        </Card>
    )
}

export default VulnerabilityCard
